<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --success: #10b981; --gray: #64748b; }
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; margin: 20px; color: #1e293b; line-height: 1.5; }
        
        .flex-row { 
            display: flex; 
            gap: 6px; 
            align-items: center; 
            width: 100%; 
        }
    
        .flex-row input { 
            flex-grow: 1; 
            min-width: 0;
        }

        .btn-small { 
            padding: 6px 10px; 
            border-radius: 6px; 
            border: 1px solid #e2e8f0; 
            cursor: pointer; 
            font-size: 11px; 
            font-weight: 500; 
            background: white;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .cash-form-row {
            display: flex;
            gap: 4px;
            width: 100%;
        }
        .cash-form-row input { flex: 1; }
        .cash-form-row .btn-small { flex-shrink: 0; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .top-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .bottom-row { display: grid; grid-template-columns: 320px 1fr; gap: 15px; }

        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display: flex; flex-direction: column; position: relative; }
        .card h2 { font-size: 1rem; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        
        .label { font-size: 0.75rem; font-weight: 600; color: var(--gray); display: block; margin-bottom: 4px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; font-size: 13px; transition: border 0.2s; }
        input:focus { outline: none; border-color: var(--primary); }
        
        .btn-primary { background: var(--primary); color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }
        
        table { width: 100%; border-collapse: collapse; }
        th { color: #94a3b8; font-size: 0.7rem; padding: 8px; text-align: center; border-bottom: 1px solid #f1f5f9; }
        td { padding: 10px 4px; border-bottom: 1px solid #f8fafc; text-align: center; font-size: 0.85rem; }

        #searchResults { position: absolute; width: calc(100% - 40px); background: white; border: 1px solid #e2e8f0; border-radius: 8px; z-index: 100; display: none; margin-top: 45px; max-height: 150px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 12px; }
        .search-item:hover { background: #f8fafc; color: var(--primary); }

        .error-msg { color: var(--danger); font-size: 11px; font-weight: 700; margin-top: 8px; text-align: center; display: none; min-height: 16px; }

        .chart-container { width: 100%; height: 670px; overflow: hidden; border-radius: 16px; background: #f8fafc; position: relative; border: 1px solid #f1f5f9; }
        #chartFrame { width: 100%; height: 100%; border: none; }
        
        .period-btn, .tab-btn {
            padding: 8px 16px;
            border-radius: 9999px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .period-btn:hover, .tab-btn:hover { background: #f1f5f9; transform: translateY(-1px); }
        
        .period-btn.active, .tab-btn.active {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

/* [1] ê¸°ë³¸ê°’: PC í™”ë©´ (ë„ˆë¹„ 1101px ì´ìƒ) */
.top-row { 
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 15px; 
    margin-bottom: 20px; 
}
.bottom-row { 
    display: grid; 
    grid-template-columns: 320px 1fr; 
    gap: 15px; 
}
/* PCì—ì„œëŠ” í…Œì´ë¸” í˜•ì‹ì„ ìœ ì§€ */
table { display: table; width: 100%; }
tr { display: table-row; }
td, th { display: table-cell; }


/* [2] íƒœë¸”ë¦¿ ë‹¨ê³„ (ë„ˆë¹„ 769px ~ 1100px) */
@media (max-width: 1100px) {
    .top-row {
        grid-template-columns: repeat(2, 1fr) !important; /* 2x2 ë°°ì¹˜ */
    }
    .bottom-row {
        grid-template-columns: 1fr !important; /* ìì‚°ìš”ì•½ê³¼ ì°¨íŠ¸ë¥¼ ìœ„ì•„ë˜ë¡œ */
    }
    /* íƒœë¸”ë¦¿ê¹Œì§€ëŠ” ì•„ì§ 'í‘œ' í˜•íƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤ */
}


/* [3] ëª¨ë°”ì¼ ë‹¨ê³„ (ë„ˆë¹„ 768px ì´í•˜) */
@media (max-width: 768px) {
    /* 1. ê¸°ë³¸ ë ˆì´ì•„ì›ƒ (ì„¸ë¡œë¡œ ìŒ“ê¸°) */
    .top-row, .bottom-row {
        display: flex !important;
        flex-direction: column !important;
        gap: 15px;
    }

    /* =======================================================
       2. ì¼ë°˜ í…Œì´ë¸” -> "ì¹´ë“œí˜•" ë³€í™˜ (ë‚´ í¬íŠ¸í´ë¦¬ì˜¤, ê±°ë˜ ë“±ì— ì ìš©)
       ======================================================= */
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; } 

    tr {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 12px;
        padding: 12px 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px dashed #f8fafc;
        text-align: right;
    }

    td:last-child { border-bottom: none; justify-content: center; }

    td::before {
        content: attr(data-label);
        font-weight: 700;
        color: #94a3b8;
        font-size: 0.8rem;
        text-align: left;
    }


    /* =======================================================
       3. ğŸš¨ ì˜¤ì§ "ì‹œì¥ í˜„í™©" ì „ìš© ì² ë²½ Grid ë°©ì–´ (ì¹´ë“œí™” ë¬´ì‹œ!)
       ======================================================= */
/* --- [ì‹œì¥ í˜„í™©] ê°•ì œ ë ˆì´ì•„ì›ƒ ìˆ˜ì • --- */
#market-table {
    display: table !important; /* block ëŒ€ì‹  table ìœ ì§€ */
    width: 100% !important;
    border-collapse: collapse;
    table-layout: fixed; /* ì»¬ëŸ¼ ë„ˆë¹„ ê³ ì •ìœ¼ë¡œ ì‚ì ¸ë‚˜ê° ë°©ì§€ */
}

/* ì‹œì¥ í˜„í™© í…Œì´ë¸” ìŠ¤í¬ë¡¤ ë° ì˜ë¦¼ ë°©ì§€ */
#market-table {
    display: table !important;
    width: 100% !important;
    table-layout: fixed; /* í…Œì´ë¸” ë„ˆë¹„ ê³ ì • */
}

#market-table td {
    overflow: hidden;
    text-overflow: ellipsis; /* ì´ë¦„ ê¸¸ë©´ ... ì²˜ë¦¬ */
    white-space: nowrap;
}

#market-table thead {
    display: table-header-group !important; /* í—¤ë” ì •ìƒí™” */
}

#market-table tbody {
    display: table-row-group !important; /* ë°ì´í„° ì˜ì—­ ì •ìƒí™” */
}

#market-table tr {
    display: table-row !important; /* flex ëŒ€ì‹  table-row */
    height: 40px; /* ìµœì†Œ ë†’ì´ ë³´ì¥ */
}

#market-table th, #market-table td {
    display: table-cell !important; /* cell êµ¬ì¡° ìœ ì§€ */
    vertical-align: middle;
    padding: 8px 4px !important;
    font-size: 0.85rem !important;
    border-bottom: 1px solid #f1f5f9 !important;
}

/* ì œëª©ì¤„ ìŠ¤íƒ€ì¼ ì •ë¦¬ */
#market-table th {
    font-size: 0.75rem !important; /* rem ì•ì— ìˆ˜ì¹˜ ì¶”ê°€ */
    color: #94a3b8;
    background: #f8fafc;
}

/* ì»¬ëŸ¼ë³„ ë„ˆë¹„ ë° ì •ë ¬ ê°•ì œ */
#market-table td:nth-child(1) { width: 45%; text-align: left !important; padding-left: 10px !important; } /* ì¢…ëª©ëª… */
#market-table td:nth-child(2) { width: 40%; text-align: right !important; padding-right: 15px !important; } /* ê°€ê²© */
#market-table td:nth-child(3) { width: 15%; text-align: center !important; } /* ì‚­ì œë²„íŠ¼ */

/* ê°€ì§œ ë¼ë²¨ ì œê±° ë° ë²„íŠ¼ ìµœì í™” */
#market-table td::before { content: none !important; }
#market-table td button {
    line-height: 1;
    transform: scale(1.2); /* í„°ì¹˜í•˜ê¸° ì‰½ê²Œ ì•½ê°„ í‚¤ì›€ */
}

    /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆì˜ ì—¬ë°±ë„ í•¨ê»˜ ì¤„ì—¬ì•¼ íš¨ê³¼ê°€ í½ë‹ˆë‹¤ */
    .card {
        padding: 12px !important; /* ì¹´ë“œ ë‚´ë¶€ ì—¬ë°± ì¶•ì†Œ */
        margin-bottom: 10px !important; /* ì¹´ë“œ ê°„ ê°„ê²© ì¶•ì†Œ */
    }

    /* =======================================================
       4. ê¸°íƒ€ í™”ë©´ ìµœì í™”
       ======================================================= */
    .chart-container { height: 400px !important; min-height: 350px; }
    .header { flex-direction: column !important; align-items: flex-start !important; gap: 15px; }
    #dateContainer { width: 100%; justify-content: space-between; padding: 10px; box-sizing: border-box; }
}

/* ê²€ìƒ‰ë°”ê°€ ì¹´ë“œ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì„¤ì • */
.card input[type="text"], 
#ticker-input, /* ì‹¤ì œ IDê°€ ìˆë‹¤ë©´ ì¶”ê°€ */
.search-input { /* ì‹¤ì œ í´ë˜ìŠ¤ê°€ ìˆë‹¤ë©´ ì¶”ê°€ */
    width: 100% !important;      /* ë¶€ëª¨ ë„ˆë¹„ì— ê½‰ ì±„ì›€ */
    box-sizing: border-box !important; /* íŒ¨ë”©ê³¼ í…Œë‘ë¦¬ë¥¼ ë„ˆë¹„ì— í¬í•¨ (í•µì‹¬!) */
    max-width: 100% !important;   /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
    display: block !important;
    margin-bottom: 10px;          /* ì•„ë˜ìª½ ìš”ì†Œì™€ ê°„ê²© */
}

/* ëª¨ë°”ì¼ í™”ë©´ì—ì„œ íŠ¹íˆ ë” ì‹ ê²½ ì“°ê¸° */
@media (max-width: 768px) {
    .card input[type="text"] {
        font-size: 16px; /* ëª¨ë°”ì¼ì—ì„œ ì…ë ¥ ì‹œ í™”ë©´ í™•ëŒ€ ë°©ì§€ */
        padding: 10px;   /* í„°ì¹˜í•˜ê¸° í¸í•œ ë†’ì´ */
    }
}

    </style>
</head>
<body>

<div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; width: 100%;">
    <h1 style="margin: 0; flex-shrink: 0;">ğŸ“Š <span style="color:var(--primary)">ë¼ê³ </span> í•  ë•Œ ì‚´ ê±¸</h1>
    
    <div id="dateContainer" style="background: white; padding: 10px 18px; border-radius: 16px; border: 2px solid var(--primary); display: flex; gap: 12px; align-items: center; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15); flex-shrink: 0;">
        
        <div style="display: flex; flex-direction: column;">
            <span id="dateLabel" style="margin:0; font-size: 0.65rem; color: var(--primary); font-weight: 800; letter-spacing: -0.02em;">CURRENT TARGET DATE</span>
            <div style="display: flex; align-items: center; gap: 5px;">
                <span style="font-size: 1.1rem;">ğŸ“…</span>
                <input type="date" id="datePicker" value="{{ target_date }}" onchange="handleDateChange()"
                       style="padding: 2px; border: none; background: transparent; font-size: 1rem; font-weight: 800; color: #1e293b; cursor: pointer; outline: none; width: 135px;">
            </div>
        </div>
        
        <div style="display: flex; gap: 6px; align-items: center;">
            <button id="dateBtn" onclick="goToDate()" 
                    style="background:var(--primary); color:white; border:none; padding: 8px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: all 0.3s ease;">
                ì ìš©ë¨
            </button>

            <button onclick="resetToToday()" 
                    style="background:#f1f5f9; color:#64748b; border: 1px solid #e2e8f0; padding: 8px 12px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; cursor: pointer; white-space: nowrap;">
                ë³µê·€
            </button>
        </div>
    </div>
</div>

<div class="top-row">
    <div class="card">
        <h2>â• ê±°ë˜ ì‹¤í–‰</h2>
        <form action="/add_transaction" method="post" id="tradeForm">
            <div style="margin-bottom:10px;">
                <span class="label">ì¢…ëª© ì„ íƒ</span>
                <select name="name" id="stockSelect" onchange="changeStock(this.value)">
                    {% for stock in available_stocks %}
                    <option value="{{ stock }}" {% if stock == available_stocks[0] %}selected{% endif %}>{{ stock }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-bottom:10px;">
                <span class="label">ê±°ë˜ ì¢…ë¥˜</span>
                <select name="type" id="tradeType" onchange="validateTrade()">
                    <option value="BUY">ë§¤ìˆ˜</option>
                    <option value="SELL">ë§¤ë„</option>
                </select>
            </div>
            <div style="margin-bottom:10px;">
                <span class="label">ì²´ê²° ë‹¨ê°€</span>
                <div class="flex-row">
                    <input type="number" step="0.01" name="price" id="priceInput" oninput="validateTrade()" placeholder="0.00" required>
                    <button type="button" onclick="fillCurrentPrice()" class="btn-small">í˜„ì¬ê°€</button>
                </div>
            </div>
            <div style="margin-bottom:10px;">
                <span class="label">ìˆ˜ëŸ‰</span>
                <div class="flex-row">
                    <input type="number" name="quantity" id="quantityInput" oninput="validateTrade()" placeholder="0" required>
                    <button type="button" onclick="fillMaxQuantity()" class="btn-small" style="background:#6366f1; color:white; border:none;">ì „ëŸ‰</button>
                </div>
            </div>
            <div id="tradeError" class="error-msg"></div>
            <button type="submit" id="submitBtn" class="btn-primary">ê±°ë˜ í™•ì •</button>
        </form>
    </div>

    <div class="card">
        <h2>ğŸ“¡ ì‹œì¥ í˜„í™© <span style="font-size: 0.7rem; color: var(--gray); font-weight: 400;">($: {{ usd_rate }})</span></h2>
        <div style="overflow-y: auto; max-height: 350px;">
            <table id="market-table">
                <thead><tr><th>ì¢…ëª©</th><th>ê°€ê²©</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="market-list">

{% for name, info in market_info.items() %}
<tr>
    <td data-label="ì¢…ëª©" style="font-weight:600; text-align: left;">{{ name }}</td>
    
    <td data-label="ê°€ê²©" style="color:var(--success); font-weight:700; text-align:right;">
        {{ info.currency_symbol }}{{ "{:,.2f}".format(info.price) if info.currency == 'USD' else "{:,.0f}".format(info.price) }}
    </td>
    
    <td>
        <button type="button" onclick="removeStock('{{ name }}')" 
                style="background:none; border:none; color:#cbd5e1; cursor:pointer; font-size: 1.2rem;">âœ–</button>
    </td>
</tr>
{% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ” ì¢…ëª© ì¶”ê°€</h2>
        <div style="position: relative;">
            <span class="label">í‹°ì»¤/ì¢…ëª©ëª… ê²€ìƒ‰</span>
            <input type="text" id="tickerSearch" placeholder="AAPL, ì‚¼ì„±ì „ì, í…ŒìŠ¬ë¼..." onkeyup="doSearch(this.value)" autocomplete="off">
            <div id="searchResults"></div>
        </div>
        <form action="/add_stock" method="post" id="addStockForm" style="display: none; margin-top:15px; padding:15px; background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0;">
            <input type="hidden" name="name" id="selectedName">
            <input type="hidden" name="ticker" id="selectedTicker">
            <div id="selectionInfo" style="font-size: 12px; color:var(--primary); font-weight:800; margin-bottom:10px; border-left:3px solid var(--primary); padding-left:8px;"></div>
            <span class="label">ê±°ë˜ í†µí™”</span>
            <select name="currency" style="margin-bottom:10px;">
                <option value="USD">USD (ë¯¸êµ­ì£¼ì‹)</option>
                <option value="KRW">KRW (êµ­ë‚´ì£¼ì‹)</option>
            </select>
            <button type="submit" onclick="handleAddStock(event)" class="btn-primary">ê´€ì‹¬ ì¢…ëª© ë“±ë¡</button>     </form>
    </div>

    <div class="card">
        <h2>ğŸ“ ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h2>
        <div style="overflow-y: auto; max-height: 350px;">
            <table>
                <thead>
                    <tr><th style="text-align:left">ì¢…ëª©</th><th>ë³´ìœ </th><th style="text-align:right">í˜„ì¬ê°€</th><th style="text-align:right">ì†ìµ</th></tr>
                </thead>
                <tbody>
 {% for item in portfolio %}
<tr>
    <td data-label="ì¢…ëª©" style="text-align:left; font-weight:600;">{{ item.name }}</td>
    
    <td data-label="ë³´ìœ " style="font-weight:700;">{{ item.quantity }}ì£¼</td>
    
    <td data-label="í˜„ì¬ê°€" style="text-align:right; font-weight:600;">{{ item.currency_symbol }}{{ item.current_price_str }}</td>
    
    <td data-label="ì†ìµ" style="text-align:right; font-weight:800; color: {% if '+' in item.profit_pct_str %}#10b981{% else %}#ef4444{% endif %};">
        {{ item.profit_str }}<br><small style="font-size:0.8rem;">({{ item.profit_pct_str }})</small>
    </td>
</tr>
{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="bottom-row">
    <div class="card">
        <h2>ğŸ’° ìì‚° ìš”ì•½</h2>
        <div style="font-size: 1.5rem; font-weight: 900;">{{ total_asset }} <small style="font-size:0.8rem; color:var(--gray)">ì›</small></div>
        <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 20px;">í˜„ê¸ˆ ì”ì•¡: <strong>{{ cash }}ì›</strong></div>
        <form action="/cash_transaction" method="post" style="border-top: 1px solid #f1f5f9; padding-top:20px;">
            <span class="label">ì…ì¶œê¸ˆ ê´€ë¦¬</span>
            <div class="cash-form-row">
                <input type="number" name="amount" placeholder="ê¸ˆì•¡ ì…ë ¥" required>
                <button type="submit" name="type" value="DEPOSIT" class="btn-small" style="background:var(--success); color:white; border:none;">ì…ê¸ˆ</button>
                <button type="submit" name="type" value="WITHDRAW" class="btn-small" style="background:var(--danger); color:white; border:none;">ì¶œê¸ˆ</button>
            </div>
        </form>
        <div style="flex-grow:1"></div>
        <button onclick="confirmReset()" style="width:100%; margin-top:20px; background:#fff1f2; color:var(--danger); border:1px solid #fee2e2; padding:10px; border-radius:8px; font-size:11px; cursor:pointer; font-weight:600;">ğŸ”„ ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>

    <div class="card">
        <h2>ğŸ“Š ê¸°ìˆ ì  ë¶„ì„ ì°¨íŠ¸</h2>
        <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <div id="stockTabs" style="display:flex; gap:6px; flex-wrap:wrap;">
                {% for s_name in available_stocks %}
                <button onclick="changeStock('{{ s_name }}')" id="tab-{{ s_name }}" class="tab-btn {% if loop.first %}active{% endif %}">
                    {{ s_name }}
                </button>
                {% endfor %}
            </div>
            <div id="periodTabs" style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
                <button onclick="changePeriod('5d')"  id="p-5d"  class="period-btn active">5ì¼</button>
                <button onclick="changePeriod('1mo')" id="p-1mo" class="period-btn">1ê°œì›”</button>
                <button onclick="changePeriod('3mo')" id="p-3mo" class="period-btn">3ê°œì›”</button>
                <button onclick="changePeriod('1y')"  id="p-1y"  class="period-btn">1ë…„</button>
                <button onclick="changePeriod('max')" id="p-max" class="period-btn">MAX</button>
            </div>
        </div>
        <div class="chart-container">
            <iframe id="chartFrame" scrolling="no"></iframe>
        </div>
    </div>
</div>

<script>
    const marketData = { {% for name, info in market_info.items() %}"{{ name }}": { price: {{ info.price }}, currency: "{{ info.currency }}" },{% endfor %} };
    const holdings = { {% for name, qty in holdings.items() %}"{{ name }}": {{ qty }},{% endfor %} };
    const currentCash = {{ cash_raw }};
    const usdRate = {{ usd_rate }};
    const initialDate = "{{ target_date }}";

    let currentStock = "{{ available_stocks[0] if available_stocks else '' }}";
    let currentPeriod = "5d";

    // â˜… í•µì‹¬: ì°¨íŠ¸ ë¡œë“œ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ í†µí•© í•¨ìˆ˜
    function loadChart() {
        if (!currentStock) return;
        const targetDate = document.getElementById('datePicker').value || "";
        const timestamp = new Date().getTime();
        const url = `/chart/${encodeURIComponent(currentStock)}/${currentPeriod}?end_date=${targetDate}&t=${timestamp}`;
        
        document.getElementById('chartFrame').src = url;
        
        // ì¢…ëª© íƒ­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.id === `tab-${currentStock}`);
        });
        
        // ê¸°ê°„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.toggle('active', btn.id === `p-${currentPeriod}`);
        });
    }

    function changeStock(n) { 
        currentStock = n; 
        document.getElementById('stockSelect').value = n; 
        loadChart(); 
        validateTrade(); 
    }

    function changePeriod(p) { 
        currentPeriod = p; 
        loadChart(); 
    }

    function validateTrade() {
        const type = document.getElementById('tradeType').value;
        let price = parseFloat(document.getElementById('priceInput').value) || 0;
        const qty = parseInt(document.getElementById('quantityInput').value) || 0;
        const name = document.getElementById('stockSelect').value;
        const errorEl = document.getElementById('tradeError');
        const submitBtn = document.getElementById('submitBtn');
       
        let errorMsg = "";
        if (price <= 0 || qty <= 0) {
            submitBtn.disabled = true;
            return;
        }
        if (type === "BUY") {
            const info = marketData[name];
            const totalCost = info.currency === "USD" ? (price * qty * usdRate) : (price * qty);
            if (totalCost > currentCash) errorMsg = "âŒ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (í•„ìš”: " + Math.round(totalCost).toLocaleString() + "ì›)";
        } else {
            const myQty = holdings[name] || 0;
            if (qty > myQty) errorMsg = "âŒ ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (í˜„ì¬: " + myQty + "ì£¼)";
        }
        
        if (errorMsg) {
            errorEl.innerText = errorMsg;
            errorEl.style.display = "block";
            submitBtn.disabled = true;
        } else {
            errorEl.style.display = "none";
            submitBtn.disabled = false;
        }
    }

// 1. ë‚ ì§œê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ UIë¥¼ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë°”ê¾¸ëŠ” í•¨ìˆ˜
function handleDateChange() {
    const currentDate = document.getElementById('datePicker').value;
    const container = document.getElementById('dateContainer');
    const btn = document.getElementById('dateBtn');
    const label = document.getElementById('dateLabel');

    if (currentDate !== initialDate) {
        // ë³€ê²½ ê°ì§€ ì‹œ ë¹¨ê°„ìƒ‰ í…Œë§ˆ
        container.style.borderColor = "#ef4444"; // danger color
        btn.style.background = "#ef4444";
        btn.innerText = "ë‚ ì§œ ë³€ê²½";
        label.style.color = "#ef4444";
    } else {
        // ì›ë˜ëŒ€ë¡œ ë³µêµ¬ ì‹œ íŒŒë€ìƒ‰ í…Œë§ˆ
        container.style.borderColor = "var(--primary)";
        btn.style.background = "var(--primary)";
        btn.innerText = "ì ìš©ë¨";
        label.style.color = "var(--primary)";
    }
}

function goToDate() {
    const selectedDate = document.getElementById('datePicker').value;
    location.href = `/?target_date=${selectedDate}`;
}

    function fillCurrentPrice() {
        const s = document.getElementById('stockSelect').value;
        if(marketData[s]) {
            const price = marketData[s].price;
            document.getElementById('priceInput').value = parseFloat(price.toFixed(2));
            validateTrade();
        }
    }

    function fillMaxQuantity() {
        const type = document.getElementById('tradeType').value;
        const price = parseFloat(document.getElementById('priceInput').value) || 0;
        const name = document.getElementById('stockSelect').value;
        if (price <= 0) { alert("ë¨¼ì € ì²´ê²° ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
        if (type === "BUY") {
            const info = marketData[name];
            const cost = info.currency === "USD" ? price * usdRate : price;
            document.getElementById('quantityInput').value = Math.floor(currentCash / cost);
        } else { 
            document.getElementById('quantityInput').value = holdings[name] || 0;
        }
        validateTrade();
    }

async function doSearch(q) {
    const box = document.getElementById('searchResults');
    if(q.length < 2) { box.style.display = 'none'; return; }
    try {
        const res = await fetch(`/search_ticker?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        if(data.length > 0) {
            // i.exchange ì •ë³´ë¥¼ selectStock í•¨ìˆ˜ì— í•¨ê»˜ ì „ë‹¬í•˜ë„ë¡ ìˆ˜ì •
            box.innerHTML = data.map(i => `
                <div class="search-item" onclick="selectStock('${i.symbol}','${i.shortname}','${i.exchange}')">
                    <strong>${i.symbol}</strong> | ${i.shortname} <small style="color:#94a3b8">(${i.exchange})</small>
                </div>
            `).join('');
            box.style.display = 'block';
        } else { box.style.display = 'none'; }
    } catch(e) { console.error(e); }
}

// 2. selectStock ìˆ˜ì •: exchange ê°’ì„ ë³´ê³  í†µí™” ìë™ ì„ íƒ
function selectStock(t, n, ex) {
    document.getElementById('selectedName').value = n;
    document.getElementById('selectedTicker').value = t;
    document.getElementById('selectionInfo').innerText = `ì„ íƒë¨: ${n} (${t})`;
    
    // í†µí™” ì„ íƒ select ë°•ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    const currencySelect = document.querySelector('select[name="currency"]');
    
    // í•œêµ­ ê±°ë˜ì†Œ ì½”ë“œ(KSC, KSD)ì¸ ê²½ìš° KRWë¡œ ë³€ê²½, ê·¸ ì™¸ëŠ” USD
    if (ex === "KSC" || ex === "KSD" || t.endsWith(".KS") || t.endsWith(".KQ")) {
        currencySelect.value = "KRW";
    } else {
        currencySelect.value = "USD";
    }

    document.getElementById('addStockForm').style.display = 'block';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('tickerSearch').value = t;
}

async function handleAddStock(event) {
    if (event) event.preventDefault(); 

    const ticker = document.getElementById('selectedTicker').value;
    const name = document.getElementById('selectedName').value;
    const currency = document.querySelector('select[name="currency"]').value;

    if (!ticker || !name) {
        alert("ì¢…ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    const formData = new FormData();
    formData.append('ticker', ticker);
    formData.append('name', name);
    formData.append('currency', currency);

    try {
        const res = await fetch('/add_stock', {
            method: 'POST',
            body: formData,
            // ìºì‹œ ë¬¸ì œ ë°©ì§€
            cache: 'no-cache'
        });

        // 303 Redirectë“  200 OKë“  ì„±ê³µí•˜ë©´ í˜ì´ì§€ë¥¼ ê°•ì œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ 
        // ì„œë²„ì˜ ìµœì‹  ëª©ë¡()ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê²Œ í•©ë‹ˆë‹¤.
        if (res.ok || res.redirected) {
            // ë‹¨ìˆœ href ì´ë™ë³´ë‹¤ reloadê°€ í˜„ì¬ íŒŒë¼ë¯¸í„°(ë‚ ì§œ ë“±) ìœ ì§€ì— ìœ ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            window.location.reload(true); 
        } else {
            const errorText = await res.text();
            alert("ì¶”ê°€ ì‹¤íŒ¨: " + errorText);
        }
    } catch (e) {
        console.error("ì—ëŸ¬ ë°œìƒ:", e);
        alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
}

// ì‹œì¥ í˜„í™© í…Œì´ë¸”ì— ìƒˆë¡œìš´ í–‰ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ (ìš°ë¦¬ê°€ ë§Œë“  ë””ìì¸ ì ìš©)
function updateMarketTable(ticker, name, price) {
    const tbody = document.querySelector('#market-table tbody');
    if (!tbody) return;

    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${name}</td>
        <td>${price}</td>
        <td><button class="delete-btn" onclick="deleteStock('${ticker}', this)">X</button></td>
    `;
    tbody.appendChild(row);
}

// ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì¦‰ì‹œ ë³µê·€í•˜ëŠ” í•¨ìˆ˜
function resetToToday() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    
    const formattedToday = `${year}-${month}-${day}`;
    location.href = `/?target_date=${formattedToday}`;
}

// ì¢…ëª© ì‚­ì œ ë¹„ë™ê¸° í•¨ìˆ˜
async function removeStock(stockName) {
    if (!confirm(`'${stockName}' ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ëœ ëª¨ë“  ê±°ë˜ ë‚´ì—­ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

    try {
        // ë°±ì—”ë“œì˜ @app.post("/delete_stock/{name}") ê²½ë¡œë¡œ ìš”ì²­
        const response = await fetch(`/delete_stock/${encodeURIComponent(stockName)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.redirected) {
            // ì„œë²„ì—ì„œ RedirectResponse(url="/")ë¥¼ ë³´ëƒˆì„ ê²½ìš° í•´ë‹¹ URLë¡œ ì´ë™
            window.location.href = response.url;
        } else if (response.ok) {
            // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.reload();
        } else {
            alert("ì‚­ì œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (e) {
        console.error("ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
        alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}



    function confirmReset() { if(confirm("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.")) { const f=document.createElement('form'); f.method='POST'; f.action='/reset'; document.body.appendChild(f); f.submit(); } }

    document.addEventListener('DOMContentLoaded', () => {
        loadChart();
        validateTrade();
    });
</script>
</body>
</html>