<!DOCTYPE html>
<html>
<head>
    <title>ì£¼ì‹ ì‹œë®¬ë ˆì´í„°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 1. ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° í°íŠ¸ ì„¤ì • */
        body { font-family: 'Pretendard', -apple-system, sans-serif; background-color: #f3f4f6; margin: 30px; color: #1e293b; line-height: 1.6; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .header h1 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.02em; margin: 0; }

        /* 2. ìƒë‹¨ 4ë‹¨ ê·¸ë¦¬ë“œ (ì—¬ë°± í™•ë³´) */
        .top-row { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 25px;
        }

        /* 3. í•˜ë‹¨ 2ë‹¨ ê·¸ë¦¬ë“œ */
        .bottom-row { 
            display: grid; 
            grid-template-columns: 320px 1fr; 
            gap: 20px; 
        }

        /* 4. ì¹´ë“œ ë””ìì¸ */
        .card { 
            background: white; 
            padding: 24px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
            border: 1px solid rgba(226, 232, 240, 0.8);
            display: flex;
            flex-direction: column;
        }
        
        .card h2 { 
            margin-top: 0; 
            font-size: 1.1rem; 
            font-weight: 700;
            color: #334155; 
            border-bottom: 2px solid #f1f5f9; 
            padding-bottom: 14px; 
            margin-bottom: 18px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        /* 5. ì…ë ¥ í¼ ë””ìì¸ (í•œ ì¤„ ìœ ì§€ í•µì‹¬) */
        .input-group { margin-bottom: 14px; position: relative; }
        .label { font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block; }
        
        .flex-row { display: flex; align-items: center; gap: 6px; } /* ë²„íŠ¼-ì…ë ¥ì°½ ê°„ê²© */
        
        select, input { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #e2e8f0; 
            border-radius: 10px; 
            font-size: 14px; 
            box-sizing: border-box;
            background-color: #f8fafc;
            min-width: 0; /* flex í™˜ê²½ì—ì„œ ì¤„ì–´ë“¤ ìˆ˜ ìˆê²Œ ì„¤ì • */
        }
        
        /* 6. ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-primary { background: #2563eb; color: white; border: none; width: 100%; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-small { 
            background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; 
            padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;
            white-space: nowrap; flex-shrink: 0; /* ì¤„ë°”ê¿ˆ ë°©ì§€ ë° í¬ê¸° ê³ ì • */
        }

        /* 7. ì‹¤ì‹œê°„ ê³„ì‚° ì˜ì—­ */
        .calc-box { 
            background: #f1f5f9; padding: 16px; border-radius: 12px; 
            margin: 5px 0 15px 0; border: 1px solid #e2e8f0;
        }

        /* í…Œì´ë¸” ë° ê¸°íƒ€ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        table { width: 100%; border-collapse: collapse; }
        th { color: #94a3b8; font-weight: 600; padding: 10px 4px; border-bottom: 1px solid #f1f5f9; font-size: 0.75rem; }
        td { padding: 12px 4px; border-bottom: 1px solid #f8fafc; text-align: center; font-size: 0.85rem; }

        .search-results { 
            position: absolute; width: 100%; background: white; border: 1px solid #e2e8f0; 
            border-radius: 10px; z-index: 100; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
            max-height: 200px; overflow-y: auto; display: none; margin-top: 5px;
        }

        @media (max-width: 1400px) { .top-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .top-row, .bottom-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ“Š <span style="color:#2563eb">ë¼ê³ </span> í•  ë•Œ ì‚´ ê±¸</h1>
    <div style="display: flex; gap: 10px; align-items: center; background: white; padding: 8px 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
        <span class="label" style="margin:0">ë¶„ì„ ì‹œì </span>
        <input type="date" id="datePicker" value="{{ target_date }}" style="width: auto; padding: 5px;">
        <button onclick="goToDate()" class="btn-small" style="background:#3b82f6; color:white; border:none;">ì´ë™</button>
    </div>
</div>

<div class="top-row">
    <div class="card">
        <h2>â• ê±°ë˜ ì‹¤í–‰</h2>
        <form action="/add_transaction" method="post" id="tradeForm">
            <div class="input-group">
                <span class="label">ì¢…ëª© ì„ íƒ</span>
                <select name="name" id="stockSelect" onchange="updateTradeInfo()">
                    {% for stock in available_stocks %}<option value="{{ stock }}">{{ stock }}</option>{% endfor %}
                </select>
            </div>
            <div class="input-group">
                <span class="label">ìœ í˜•</span>
                <select name="type" id="typeSelect" onchange="updateTradeInfo()">
                    <option value="BUY">ë§¤ìˆ˜ (Buy)</option>
                    <option value="SELL">ë§¤ë„ (Sell)</option>
                </select>
            </div>

            <div class="input-group">
                <span class="label">ê±°ë˜ ë‹¨ê°€</span>
                <div class="flex-row">
                    <input type="number" step="0.01" name="price" id="priceInput" placeholder="0.00" oninput="calculateTotal()">
                    <button type="button" onclick="fillCurrentPrice()" class="btn-small">í˜„ì¬ê°€</button>
                </div>
            </div>

            <div class="input-group">
                <span class="label">ìˆ˜ëŸ‰</span>
                <div class="flex-row">
                    <input type="number" name="quantity" id="quantityInput" placeholder="0" oninput="calculateTotal()">
                    <button type="button" onclick="fillMaxQuantity()" class="btn-small" style="background:#6366f1; color:white; border:none;">ì „ëŸ‰</button>
                </div>
            </div>

            <div class="calc-box">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.7rem; color: #64748b; font-weight: 600;">ì˜ˆìƒ ê¸ˆì•¡</span>
                    <span id="estimatedTotal" style="font-weight: 800; color: #1e293b; font-size: 0.95rem;">0ì›</span>
                </div>
                <div id="tradeWarning" style="font-size: 0.7rem; color: #ef4444; margin-top: 6px; display: none; font-weight: 600;"></div>
            </div>
        
            <button type="submit" id="submitBtn" class="btn-primary">ê±°ë˜ í™•ì •</button>
        </form>
    </div>

    <div class="card">
        <h2>ğŸ“¡ ì‹œì¥ í˜„í™© <span style="font-size: 0.7rem; color: #94a3b8; font-weight: 400;">í™˜ìœ¨: {{ usd_rate }}</span></h2>
        <div style="overflow-y: auto; max-height: 400px;">
            <table>
                <thead><tr><th>ì¢…ëª©ëª…</th><th>í˜„ì¬ê°€</th><th>ì‚­ì œ</th></tr></thead>
                <tbody>
                    {% for name, info in market_info.items() %}
                    <tr>
                        <td style="font-weight:700; color:#334155;">{{ name }}</td>
                        <td style="color:#10b981; font-weight:700;">{{ "{:,.2f}".format(info.price) if info.currency == 'USD' else "{:,.0f}".format(info.price) }}</td>
                        <td>
                            <form action="/delete_stock/{{ name }}" method="post" onsubmit="return confirm('ì‚­ì œí• ê¹Œìš”?')">
                                <button type="submit" style="background:none; border:none; color:#cbd5e1; cursor:pointer;">âœ–</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ” ì¢…ëª© ì¶”ê°€</h2>
        <div class="input-group">
            <span class="label">ì¢…ëª©ëª…/í‹°ì»¤ ê²€ìƒ‰</span>
            <input type="text" id="tickerSearch" placeholder="ì˜ˆ: ì—”ë¹„ë””ì•„, ì‚¼ì„±ì „ì" onkeyup="doSearch(this.value)" autocomplete="off">
            <div id="searchResults" class="search-results"></div>
        </div>
        <form action="/add_stock" method="post" id="addStockForm" style="display: none; margin-top: 10px; padding: 15px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
            <input type="hidden" name="name" id="selectedName">
            <input type="hidden" name="ticker" id="selectedTicker">
            <div id="selectionInfo" style="font-size: 0.8rem; margin-bottom: 10px; color: #2563eb; font-weight: 700;"></div>
            <div class="input-group">
                <select name="currency" id="selectedCurrency">
                    <option value="USD">USD (ë¯¸êµ­ì£¼ì‹)</option>
                    <option value="KRW">KRW (í•œêµ­ì£¼ì‹)</option>
                </select>
            </div>
            <button type="submit" class="btn-primary" style="background:#6366f1; padding: 8px;">ì¶”ê°€í•˜ê¸°</button>
        </form>
    </div>

    <div class="card">
        <h2>ğŸ“ í¬íŠ¸í´ë¦¬ì˜¤</h2>
        <div style="overflow-y: auto; max-height: 400px;">
            <table>
                <thead><tr><th>ì¢…ëª©</th><th>ë³´ìœ </th><th>ìˆ˜ìµë¥ </th></tr></thead>
                <tbody>
                    {% for item in portfolio %}
                    <tr>
                        <td style="font-weight:600;">{{ item.name }}</td>
                        <td>{{ item.quantity }}ì£¼</td>
                        <td style="color: {% if item.profit_krw >= 0 %}#ef4444{% else %}#2563eb{% endif %}; font-weight: 800;">
                            {{ item.p_str }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="bottom-row">
    <div class="card">
        <h2>ğŸ’° ìì‚° ìš”ì•½</h2>
        <div style="padding: 5px 0;">
            <span class="label">ì´ ì¶”ì • ìì‚°</span>
            <div style="font-size: 1.6rem; font-weight: 900; color: #1e293b; margin-bottom: 15px;">{{ total_asset }} <small style="font-size: 0.8rem; color:#94a3b8">ì›</small></div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem;">
                <span style="color: #64748b;">ë³´ìœ  í˜„ê¸ˆ</span>
                <span style="font-weight: 700;">{{ cash }}ì›</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.85rem;">
                <span style="color: #64748b;">ì£¼ì‹ í‰ê°€ì•¡</span>
                <span style="font-weight: 700;">{{ total_value }}ì›</span>
            </div>
            
            <button onclick="confirmReset()" style="width:100%; padding: 8px; background:#fff1f2; color:#ef4444; border:1px solid #fee2e2; border-radius:10px; font-size: 11px; cursor:pointer; font-weight: 700;">ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“Š ê¸°ìˆ ì  ë¶„ì„ ì°¨íŠ¸</h2>
        <iframe id="chartFrame" style="width:100%; height:480px; border:none; background:#f8fafc; border-radius: 12px;"></iframe>
    </div>
</div>

<script>
    /* ìŠ¤í¬ë¦½íŠ¸ ë¶€ë¶„ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë˜, ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì•ˆì „í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤ */
    const marketData = { {% for name, info in market_info.items() %}"{{ name }}": { price: {{ info.price }}, currency: "{{ info.currency }}" },{% endfor %} };
    const holdingsData = { {% for name, qty in holdings.items() %}"{{ name }}": {{ qty }},{% endfor %} };
    const currentCash = {{ cash_raw }};
    const usdRate = {{ usd_rate }};

    function fillMaxQuantity() {
        const stock = document.getElementById('stockSelect').value;
        const type = document.getElementById('typeSelect').value;
        const price = parseFloat(document.getElementById('priceInput').value);
        if (!price || price <= 0) { alert("ë‹¨ê°€ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        const info = marketData[stock];
        let maxQty = (type === "BUY") ? Math.floor(currentCash / ((info.currency === "USD") ? (price * usdRate) : price)) : (holdingsData[stock] || 0);
        document.getElementById('quantityInput').value = maxQty;
        calculateTotal();
    }

    function calculateTotal() {
        const stock = document.getElementById('stockSelect').value;
        const type = document.getElementById('typeSelect').value;
        const price = parseFloat(document.getElementById('priceInput').value) || 0;
        const qty = parseFloat(document.getElementById('quantityInput').value) || 0;
        const info = marketData[stock] || {currency: 'KRW'};
        const totalRaw = price * qty;
        let totalKRW = (info.currency === "USD") ? (totalRaw * usdRate) : totalRaw;
        
        document.getElementById('estimatedTotal').innerText = (info.currency === "USD") ? 
            `$${totalRaw.toLocaleString(undefined, {minimumFractionDigits: 2})} (ì•½ ${Math.round(totalKRW).toLocaleString()}ì›)` : 
            `${Math.round(totalKRW).toLocaleString()}ì›`;

        const warning = document.getElementById('tradeWarning');
        const submitBtn = document.getElementById('submitBtn');
        let errorMsg = (type === "BUY" && totalKRW > currentCash) ? "âš ï¸ ì”ì•¡ ë¶€ì¡±" : 
                       (type === "SELL" && qty > (holdingsData[stock] || 0)) ? `âš ï¸ ë³´ìœ ìˆ˜ëŸ‰ ì´ˆê³¼` : "";

        warning.innerText = errorMsg;
        warning.style.display = errorMsg ? "block" : "none";
        submitBtn.disabled = !!errorMsg;
        submitBtn.style.opacity = errorMsg ? 0.5 : 1;
    }

    let searchTimeout;
    async function doSearch(query) {
        clearTimeout(searchTimeout);
        const dropdown = document.getElementById('searchResults');
        if (query.length < 2) { dropdown.style.display = 'none'; return; }
        searchTimeout = setTimeout(async () => {
            const res = await fetch(`/search_ticker?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.length > 0) {
                dropdown.innerHTML = data.map(item => `<div class="search-item" onclick="selectStock('${item.symbol}', '${item.shortname}')"><strong>${item.symbol}</strong> | ${item.shortname}</div>`).join('');
                dropdown.style.display = 'block';
            }
        }, 300);
    }

    function selectStock(ticker, name) {
        document.getElementById('selectedName').value = name;
        document.getElementById('selectedTicker').value = ticker;
        document.getElementById('tickerSearch').value = name;
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('selectedCurrency').value = (ticker.endsWith('.KS') || ticker.endsWith('.KQ')) ? 'KRW' : 'USD';
        document.getElementById('selectionInfo').innerHTML = `ì„ íƒ: ${name}`;
        document.getElementById('addStockForm').style.display = 'block';
    }

    function updateTradeInfo() { calculateTotal(); loadChart(); }
    function fillCurrentPrice() { 
        const stock = document.getElementById('stockSelect').value;
        if (marketData[stock]) { document.getElementById('priceInput').value = marketData[stock].price; calculateTotal(); }
    }
    function goToDate() { const date = document.getElementById('datePicker').value; if (date) window.location.href = `/?target_date=${date}`; }
    function loadChart() {
        const stock = document.getElementById('stockSelect').value;
        const targetDate = "{{ target_date if is_backtest else '' }}";
        let url = `/chart/${encodeURIComponent(stock)}/1d`;
        if (targetDate) url += `?end_date=${targetDate}`;
        document.getElementById('chartFrame').src = url;
    }
    function confirmReset() { if (confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { const f = document.createElement('form'); f.method='POST'; f.action='/reset'; document.body.appendChild(f); f.submit(); } }

    document.addEventListener('DOMContentLoaded', loadChart);
</script>
</body>
</html>